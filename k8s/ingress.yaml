---
# BFF Ingress Configuration - STAGING/TESTING
# Using pwa.goalixa.com for testing
# TODO: After testing, replace pwa.goalixa.com with app.goalixa.com
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: bff-ingress
  namespace: goalixa-bff
  annotations:
    # NGINX ingress annotations
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # CORS headers - allow PWA domain
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://pwa.goalixa.com"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, PATCH, OPTIONS"
    nginx.ingress.kubernetes.io/cors-allow-headers: "Authorization, Content-Type, X-Requested-With, Accept, Origin"
    nginx.ingress.kubernetes.io/cors-expose-headers: "Content-Length, Content-Type"
    nginx.ingress.kubernetes.io/cors-max-age: "3600"

    # Rate limiting
    nginx.ingress.kubernetes.io/limit-rps: "100"

    # Proxy settings
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "16k"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"

    # Security headers
    nginx.ingress.kubernetes.io/referrer-policy: "strict-origin-when-cross-origin"

spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - pwa.goalixa.com
    secretName: pwa-bff-tls  # TODO: Change to app-bff-tls for production
  rules:
  - host: pwa.goalixa.com  # TODO: Change to app.goalixa.com for production
    http:
      paths:
      # BFF API endpoints
      - path: /bff
        pathType: Prefix
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      # Health checks (no auth required)
      - path: /health
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      - path: /liveness
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      - path: /readiness
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000
