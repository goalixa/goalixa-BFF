---
# BFF Ingress Configuration - STAGING/TESTING with Traefik
# Using pwa.goalixa.com for testing
# TODO: After testing, replace pwa.goalixa.com with app.goalixa.com
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: bff-ingress
  namespace: goalixa-bff
  annotations:
    # Traefik specific annotations
    traefik.ingress.kubernetes.io/router.entrypoints: web

spec:
  ingressClassName: traefik
  # TLS disabled for testing - enable after setup
  # tls:
  # - hosts:
  #   - pwa.goalixa.com
  #   secretName: pwa-bff-tls
  rules:
  - host: pwa.goalixa.com  # TODO: Change to app.goalixa.com for production
    http:
      paths:
      # BFF API endpoints
      - path: /bff
        pathType: Prefix
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      # Health checks (no auth required)
      - path: /health
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      - path: /liveness
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000
      - path: /readiness
        pathType: Exact
        backend:
          service:
            name: bff-service
            port:
              number: 8000

---
# Traefik Middleware for CORS (can be applied later if needed)
# Note: BFF FastAPI already handles CORS via app/config.py
apiVersion: traefik.containo.us/v1alpha1
kind: Middleware
metadata:
  name: bff-cors
  namespace: goalixa-bff
spec:
  headers:
    accessControlAllowMethods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS
    accessControlAllowHeaders:
      - Authorization
      - Content-Type
      - X-Requested-With
      - Accept
      - Origin
    accessControlAllowOriginList:
      - https://pwa.goalixa.com
      - http://pwa.goalixa.com
      # TODO: For production: Add https://app.goalixa.com
    accessControlMaxAge: 100
    addVaryHeader: true
